<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transfer • Declined</title>

  <style>
    body { margin:0; background:#f4f6fb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; }
    .wrap { max-width:820px; margin:24px auto; padding:0 14px; }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow:0 8px 22px rgba(0,0,0,.08); margin-bottom:14px; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:12px; font-size:13px; color:#444; }
    .txid { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; font-weight:800; }

    h1 { font-size:18px; margin:0 0 6px; }
    .pill { display:inline-block; padding:5px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fee2e2; border:1px solid #fecaca; color:#991b1b; margin-top:6px; }
    .sub { font-size:12px; color:#666; margin:10px 0 0; line-height:1.45; }

    .kv { display:grid; grid-template-columns:160px 1fr; gap:8px; font-size:14px; margin-top:12px; }
    @media (max-width:700px){ .kv{ grid-template-columns:1fr; } }
    .k { font-weight:900; color:#334; }

    .uploadBox { margin-top:14px; border:1px dashed #cbd5e1; border-radius:14px; padding:14px; background:#fafcff; }
    .boxTitle { font-weight:950; margin-bottom:6px; }
    .fileMeta { font-size:12px; color:#666; margin-top:8px; }

    input[type="file"] { width:100%; box-sizing:border-box; padding:11px 12px; border-radius:12px; border:1px solid #d7dbe6; background:#fff; font-size:14px; }

    .preview { margin-top:12px; display:none; border-radius:14px; overflow:hidden; border:1px solid #e7ebf6; background:#fff; }
    .preview img { width:100%; display:block; max-height:360px; object-fit:contain; background:#fff; }

    .btnRow { display:flex; gap:10px; margin-top:14px; }
    button { width:100%; border:0; border-radius:12px; padding:12px; font-weight:900; cursor:pointer; }
    .primary { background:#1a73e8; color:#fff; }
    .secondary { background:#e9eef9; color:#1a3d8f; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .footerNote { text-align:center; color:#7a7a7a; font-size:12px; margin-top:8px; }

    /* Loading overlay (Page 3 -> Page 4) */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(244,246,251,.88);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .overlayCard {
      width: min(420px, 100%);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      padding: 18px;
      text-align: center;
      border: 1px solid #e7ebf6;
    }
    .spinner {
      width: 42px; height: 42px; border-radius: 999px;
      border: 4px solid #d7dbe6;
      border-top-color: #1a73e8;
      margin: 8px auto 12px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .overlayTitle { font-weight: 950; font-size: 16px; margin: 4px 0; }
    .overlaySub { font-size: 12px; color: #666; margin: 0; }
  </style>
</head>

<body>
  <div class="overlay" id="overlay" aria-live="polite" aria-busy="true">
    <div class="overlayCard">
      <div class="spinner" aria-hidden="true"></div>
      <div class="overlayTitle" id="loadingTitle">Submitting document…</div>
      <p class="overlaySub" id="loadingSub">Please wait</p>
    </div>
  </div>

  <div class="wrap">
    <div class="card header">
      <div>Transaction</div>
      <div class="txid" id="txId">—</div>
    </div>

    <div class="card">
      <h1>Transfer declined</h1>
      <div class="pill">DECLINED</div>

      <p class="sub">
        Reason: Required documentation is missing. Please attach a supporting document (PDF or screenshot) for review.
      </p>

      <div class="kv">
        <div class="k">Destination bank</div><div id="bank">—</div>
        <div class="k">Recipient</div><div id="recipient">—</div>
        <div class="k">Country</div><div id="country">—</div>
        <div class="k">Client name</div><div id="clientName">—</div>
        <div class="k">Sort code</div><div id="sortCode">—</div>
        <div class="k">Account number</div><div id="accountNumber">—</div>
        <div class="k">Balance</div><div>€5,400.00</div>
      </div>

      <div class="uploadBox">
        <div class="boxTitle">Attach document</div>
        <div class="fileMeta">Accepted: PDF, PNG, JPG</div>

        <div style="margin-top:10px;">
          <input id="fileInput" type="file" accept=".pdf,image/png,image/jpeg" />
        </div>

        <div id="fileInfo" class="fileMeta"></div>

        <div id="preview" class="preview">
          <img id="imgPreview" alt="Attachment preview" />
        </div>
      </div>

      <div class="btnRow">
        <button class="secondary" id="backBtn" type="button">Back</button>
        <button class="primary" id="completeBtn" type="button" disabled>Complete submission</button>
      </div>
    </div>

    <div class="footerNote">Demo interface — no payment is processed.</div>
  </div>

  <script>
    const draftRaw = sessionStorage.getItem("transferDraft");
    if (!draftRaw) window.location.href = "index.html";
    const draft = JSON.parse(draftRaw || {});

    document.getElementById("txId").textContent = draft.txId || sessionStorage.getItem("txId") || "—";
    document.getElementById("bank").textContent = draft.transfer?.bank || "—";
    document.getElementById("recipient").textContent = draft.transfer?.recipient || "—";
    document.getElementById("country").textContent = draft.transfer?.country || "—";
    document.getElementById("clientName").textContent = draft.kyc?.clientName || "—";
    document.getElementById("sortCode").textContent = draft.kyc?.sortCode || "—";
    document.getElementById("accountNumber").textContent = draft.kyc?.accountNumber || "—";

    const overlayEl = document.getElementById("overlay");
    const loadingTitleEl = document.getElementById("loadingTitle");
    const loadingSubEl = document.getElementById("loadingSub");

    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const previewBox = document.getElementById("preview");
    const imgPreview = document.getElementById("imgPreview");
    const completeBtn = document.getElementById("completeBtn");
    const backBtn = document.getElementById("backBtn");

    let hasFile = false;

    function setLoading(isLoading) {
      overlayEl.style.display = isLoading ? "flex" : "none";
      backBtn.disabled = isLoading;
      completeBtn.disabled = isLoading || !hasFile;
      fileInput.disabled = isLoading;
    }

    fileInput.addEventListener("change", () => {
      hasFile = false;
      completeBtn.disabled = true;

      previewBox.style.display = "none";
      imgPreview.src = "";
      fileInfo.textContent = "";

      const f = fileInput.files && fileInput.files[0];
      if (!f) return;

      const sizeKb = Math.round(f.size / 1024);
      sessionStorage.setItem("attachmentName", f.name);
      sessionStorage.setItem("attachmentType", f.type);
      sessionStorage.setItem("attachmentSizeKb", String(sizeKb));

      fileInfo.textContent = `Selected: ${f.name} (${sizeKb} KB)`;

      if (f.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = () => {
          imgPreview.src = String(reader.result);
          previewBox.style.display = "block";
        };
        reader.readAsDataURL(f);
      }

      hasFile = true;
      completeBtn.disabled = false;
    });

    backBtn.addEventListener("click", () => history.back());

    completeBtn.addEventListener("click", () => {
      if (!hasFile) return;

      // Show a short logical loading before moving to Page 4
      setLoading(true);
      loadingTitleEl.textContent = "Submitting document…";
      loadingSubEl.textContent = "Securely attaching file";

      const totalMs = 2500; // ~2.5s feels realistic here
      const switchMs = 1400;
      const switchTimer = setTimeout(() => {
        loadingTitleEl.textContent = "Submission received…";
        loadingSubEl.textContent = "Preparing review";
      }, switchMs);

      setTimeout(() => {
        clearTimeout(switchTimer);
        window.location.href = "review.html";
      }, totalMs);
    });
  </script>
</body>
</html>
